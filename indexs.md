# 索引

索引通常能够极大的提高查询的效率，如果没有索引，MongoDB 在读取数据时必须扫描集合中的每个文件并选取那些符合查询条件的记录。这种扫描全集合的查询效率是非常低的，特别在处理大量的数据时，查询可以要花费几十秒甚至几分钟，这对网站的性能是非常致命的。索引是特殊的数据结构，索引存储在一个易于遍历读取的数据集合中，索引是对数据库表中一列或多列的值进行排序的一种结构。

MongoDB 中的索引其实类似于关系型数据库，都是为了提高查询和排序的效率的，并且实现原理也基本一致。由于集合中的键(字段)可以是普通数据类型，也可以是子文档。MongoDB 可以在各种类型的键上创建索引。下面分别讲解各种类型的索引的创建，查询，以及索引的维护等。

## 1.创建索引

### 1.1.默认索引

MongoDB 有个默认的“_id”的键，他相当于“主键”的角色。集合创建后系统会自动创建一个索引在“_id”键上，它是默认索引，索引名叫“_id_”，是无法被删除的。

### 1.2.单列索引

在单个键上创建的索引就是单列索引，例如我们要在“users”集合上给“username”键创建一个单列索引。

> 数字1表示username键的索引按升序存储，-1表示age键的索引按照降序方式存储。

```
db.users.ensureIndex({"username":1})
```

### 1.3.复合索引

另外，我们还可以同时对多个键创建复合索引。比如，创建“username”按照正序，“city”逆序的组合索引:

```
db.users.ensureIndex({"username":1, "city":-1})
```

该索引被创建后，基于 username 和 city 的查询将会用到该索引，或者是基于 username 的查询也会用到该索引，但是只是基于 city 的查询将不会用到该复合索引。因此可以说，如果想用到复合索引，必须在查询条件中包含复合索引中的前 N 个索引列。然而如果查询条件中的键值顺序和复合索引中的创建顺序不一致的话，MongoDB 可以智能的帮助我们调整该顺序，以便使复合索引可以为查询所用。如：

```
db.users.find({"city": "shenzhen", "username": "stephen"})
```

对于上面示例中的查询条件，MongoDB 在检索之前将会动态的调整查询条件文档的顺序，以使该查询可以用到刚刚创建的复合索引。

### 1.4.内嵌文档索引

我们可以为内嵌文档创建索引，其规则和普通文档没有任何差别，如：

```
db.users.ensureIndex({"address.date":1})
```

### 1.5.指定索引名称

对于上面创建的索引，MongoDB都会根据索引的keyname和索引方向为新创建的索引自动分配一个索引名，下面的命令可以在创建索引时为其指定索引名，如：

```
db.users.ensureIndex({"username":1},{"name":"testindex"})
```

### 1.6.唯一索引

在缺省情况下创建的索引均不是唯一索引。下面的示例将创建唯一索引，如：

```
db.users.ensureIndex({"username":1},{"unique":true})
```

如果再次插入 username 重复的文档时，MongoDB 将报错，以提示插入重复键。如果插入的文档中不包含 username 键，那么该文档中该键的值为null，如果多次插入类似的文档，MongoDB 将会报出同样的错误。

### 1.7.后台创建

如果在为已有数据的文档创建索引时，可以执行下面的命令，以使 MongoDB 在后台创建索引，这样的创建时就不会阻塞其他操作。但是相比而言，以阻塞方式创建索引，会使整个创建过程效率更高，但是在创建时 MongoDB 将无法接收其他的操作。

```
db.users.ensureIndex({"username":1},{"background":true})
```

## 2.维护索引

### 2.1.查看索引

可以通过下面的命令查看索引是否已经成功建立：

```
db.users.getIndexes()
```

### 2.2.删除索引

删除索引的命令是

```
db.users.dropIndex({"username":1})
```

### 2.3.查询分析

explain是非常有用的工具，会帮助你获得查询方面诸多有用的信息。只要对游标调用该方法，就可以得到查询细节。explain会返回一个文档，而不是游标本身。

```
db.users.find().explain()
```

## 3.注意事项

随着集合的增长，需要针对查询中大量的排序做索引。如果没有对索引的键调用sort，MongoDB需要将所有数据提取到内存并排序。因此在做无索引排序时，如果数据量过大以致无法在内存中进行排序，此时MongoDB将会报错。

每个索引占据一定的存储空间，在进行插入，更新和删除操作时也需要对索引进行操作。所以，如果你很少对集合进行读取操作，建议不使用索引。

由于索引是存储在内存(RAM)中,你应该确保该索引的大小不超过内存的限制。如果索引的大小大于内存的限制，MongoDB会删除一些索引，这将导致性能下降。

索引不能被以下的查询使用：

- 正则表达式及非操作符，如 $nin, $not, 等；
- 算术运算符，如 $mod, 等；
- $where 子句。

所以，检测你的语句是否使用索引是一个好的习惯，可以用explain来查看。

##### 最大范围

- 集合中索引不能超过64个
- 索引名的长度不能超过125个字符
- 一个复合索引最多可以有31个字段
